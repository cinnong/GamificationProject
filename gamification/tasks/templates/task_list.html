<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Daftar Tugas - Gamification Health App</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-gray-900 to-black min-h-screen flex items-center justify-center font-sans text-gray-100">

    <!-- Modal untuk Notifikasi -->
    <div id="notificationModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-lg text-center max-w-md">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ‰ Poin Diterima!</h2>
            <p class="mt-4 text-gray-600">
                Kamu telah berhasil menyelesaikan tugas dan mendapatkan poin!
            </p>
            <button
                onclick="closeModal()"
                class="mt-6 bg-purple-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-purple-700 transition duration-300"
            >
                Tutup
            </button>
        </div>
    </div>

    <!-- Container Utama -->
    <div class="bg-gray-800 max-w-3xl w-full p-10 rounded-xl shadow-2xl border border-gray-700 transform transition-all hover:scale-105 duration-500">

      <!-- Tombol Kembali ke Index -->
    <a
    href="{% url 'index' %}"
    class="mb-6 inline-block bg-blue-500 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-600 transition duration-300"
  >
    â¬… 
  </a>

        <!-- Judul Halaman -->
        <h1 class="text-5xl font-extrabold text-center text-purple-400 mb-6">
            ğŸ® Daftar Tugas Harian
        </h1>
        <p class="text-center text-gray-400 mb-8 text-lg">
            Selesaikan tugas harianmu dan dapatkan <span class="font-semibold text-purple-400">poin</span>!
        </p>

        <!-- Form Filter -->
        <form method="get" class="mb-8 flex flex-col space-y-4">
            <label for="difficulty" class="text-lg font-medium text-gray-300">ğŸšï¸ Filter Berdasarkan Tingkat Kesulitan:</label>
            <select
                name="difficulty"
                id="difficulty"
                class="p-3 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 bg-gray-700 text-gray-100"
            >
                <option value="">Semua Tugas</option>
                <option value="easy" {% if request.GET.difficulty == "easy" %}selected{% endif %}>ğŸŒ± Mudah</option>
                <option value="medium" {% if request.GET.difficulty == "medium" %}selected{% endif %}>ğŸ”¥ Menengah</option>
                <option value="hard" {% if request.GET.difficulty == "hard" %}selected{% endif %}>ğŸ’ª Sulit</option>
            </select>
            <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition duration-300 shadow-lg">
                Terapkan Filter
            </button>
        </form>
        

<!-- Daftar Tugas dengan Perbaikan -->
<ul class="space-y-6">
  <h2 class="text-3xl font-bold text-blue-400 mb-4">ğŸ“‹ Tugas Harian</h2>
  {% for task in tasks %}
  <li class="bg-gray-100 p-6 rounded-lg shadow-md flex justify-between items-center border-l-8 
      {% if task.difficulty == 'easy' %}border-green-400{% elif task.difficulty == 'medium' %}border-yellow-400{% else %}border-red-400{% endif %}">
      <div>
          <h3 class="text-2xl font-bold text-gray-800">{{ task.title }}</h3>
          <p class="text-gray-600 mt-2">{{ task.description }}</p>
          <p class="mt-2 text-sm font-semibold text-blue-600">ğŸ¯ Kesulitan: {{ task.get_difficulty_display }}</p>
          <p class="mt-2 text-sm font-semibold text-yellow-500">ğŸ’° Koin yang Diperoleh: {{ task.coin_reward }}</p>
      </div>
      <div class="flex gap-4 items-center">
          {% if not task.is_completed %}
          <!-- âœ… Perubahan: Menambahkan event onsubmit -->
          <form method="post" action="{% url 'complete_task' task.id %}" onsubmit="return confirmTaskCompletion(event, {{ task.id }}, {{ task.coin_reward }})">
              {% csrf_token %}
              <button
                  type="submit"
                  id="task-button-{{ task.id }}"
                  class="bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition duration-300 transform hover:scale-105"
              >
                  Selesaikan
              </button>
          </form>
          {% else %}
          <span class="text-lg font-bold text-green-700">âœ”ï¸ Selesai</span>
          {% endif %}
      </div>
  </li>
  {% empty %}
  <li class="text-center text-gray-600 text-lg font-semibold">
      ğŸš€ Tidak ada tugas yang tersedia! Ayo buat tantangan baru.
  </li>
  {% endfor %}
</ul>


        <!-- âœ… DAFTAR CUSTOM TASK (Ditempatkan setelah daftar tugas utama) -->
        <ul class="space-y-6 mt-12">
            <h2 class="text-3xl font-bold text-blue-400 mb-4">âœï¸ Tugas Custom</h2>
            {% for task in custom_tasks %}
            <li class="bg-gray-100 p-6 rounded-lg shadow-md flex justify-between items-center border-l-8 border-purple-400">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">{{ task.title }}</h3>
                    <p class="text-gray-600 mt-2">{{ task.description }}</p>
                    
                    <!-- <p class="mt-2 text-sm font-semibold text-blue-600">ğŸ’¡ Dibuat oleh: {{ task.user.user.username }}</p> -->
                </div>
                <div class="flex gap-4 items-center">
                  {% if not task.is_completed %}
                  <!-- Form Submit untuk menghubungkan dengan views -->
                  <form method="post" action="{% url 'complete_task' task.id %}">
                    {% csrf_token %}
                    <button
                      type="submit"
                      class="bg-green-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-600 transition duration-300 transform hover:scale-105"
                    >
                      Selesaikan
                    </button>
                  </form>
                  {% else %}
                  <span class="text-lg font-bold text-green-700">âœ”ï¸ Selesai</span>
                  
                  {% endif %} 
                </div>
            </li>
            {% empty %}
            <li class="text-center text-gray-600 text-lg font-semibold">
                ğŸš€ Kamu belum memiliki tugas custom! Ayo buat tugas baru.
            </li>
            {% endfor %}
        </ul>

        
    </div>

    <!-- JavaScript untuk Mengelola Pop-up, Form Submission, dan Visual Button -->
<!-- JavaScript yang diperbarui agar data dikirim ke server dengan AJAX -->
<script>
  function confirmTaskCompletion(event, taskId, coinReward) {
      event.preventDefault(); // Mencegah form default submission

      // Konfirmasi dengan server menggunakan AJAX
      fetch(`/tasks/complete/${taskId}/`, {
          method: 'POST',
          headers: {
              'X-CSRFToken': '{{ csrf_token }}', // Menggunakan token CSRF Django
              'Content-Type': 'application/json',
          },
      })
      .then(response => {
          if (response.ok) {
              // Menampilkan notifikasi hanya jika berhasil
              document.getElementById("notificationModal").classList.remove("hidden");
              document.querySelector("#notificationModal p").innerText = `Kamu telah berhasil menyelesaikan tugas dan mendapatkan ${coinReward} koin!`;
              
              // Update tampilan tombol selesai
              const taskButton = document.getElementById(`task-button-${taskId}`);
              taskButton.innerHTML = "âœ”ï¸ Selesai";
              taskButton.disabled = true;
              taskButton.classList.remove("bg-green-500", "hover:bg-green-600");
              taskButton.classList.add("bg-gray-400", "cursor-not-allowed");
          } else {
              alert('Terjadi kesalahan, coba lagi.');
          }
      })
      .catch(error => console.error('Error:', error));
  }

  function closeModal() {
      document.getElementById("notificationModal").classList.add("hidden");
  }
</script>


</body>
</html>
